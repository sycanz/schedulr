name: Secret Detection + Build + Deploy Backend + Deploy Extension

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main, stg]
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/**"
      - "LICENSE"
      - "CONTRIBUTING.md"
      - "CHANGELOG.md"
      - "CODE_OF_CONDUCT.md"
      - "SECURITY.md"
      - "TROUBLESHOOTING.md"
      - "QUICKSTART.md"

jobs:
  secret-detection:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-project:
    needs: secret-detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install frontend dependencies
        run: npm install

      - name: Install backend dependencies
        run: cd backend/cloudflare-workers && npm install

      - name: Build frontend and backend with production environment
        run: |
          npm run build:scraper:prod
        env:
          CLIENT_ID_PROD: ${{ secrets.CLIENT_ID_PROD }}
          CFW_AUTH_ENDPOINT_PROD: ${{ secrets.CFW_AUTH_ENDPOINT_PROD }}
          CFW_REFRESH_ENDPOINT_PROD: ${{ secrets.CFW_REFRESH_ENDPOINT_PROD }}
          CFW_CHECK_RETURN_USER_ENDPOINT_PROD: ${{ secrets.CFW_CHECK_RETURN_USER_ENDPOINT_PROD }}
          CFW_GET_CALENDAR_ENDPOINT_PROD: ${{ secrets.CFW_GET_CALENDAR_ENDPOINT_PROD }}
          CFW_ADD_NEW_EVENT_ENDPOINT_PROD: ${{ secrets.CFW_ADD_NEW_EVENT_ENDPOINT_PROD }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create production manifest
        run: |
          # Create production manifest with key field
          jq '.host_permissions |= map(select(. != "http://localhost:8787/*")) | .key = "${{ secrets.EXTENSION_PUBLIC_KEY }}"' manifest.json > manifest.prod.json
          mv manifest.prod.json manifest.json

      - name: Upload extension build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: |
            frontend/dist/
            frontend/src/
            images/
            manifest.json
          retention-days: 1

      - name: Upload worker build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: worker-build
          path: backend/cloudflare-workers/dist/
          retention-days: 1

  deploy-backend:
    needs: build-project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download worker build artifacts
        uses: actions/download-artifact@v4
        with:
          name: worker-build
          path: backend/cloudflare-workers/dist/

      - name: Create production environment file
        run: |
          cd backend/cloudflare-workers
          cat <<EOF > .dev.vars.prd
          CLIENT_ID=${{ secrets.CLIENT_ID_PROD }}
          CLIENT_SECRET=${{ secrets.CLIENT_SECRET_PROD }}
          REDIRECT_URI=${{ secrets.REDIRECT_URI }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          CFW_REFRESH_ENDPOINT=${{ secrets.CFW_REFRESH_ENDPOINT_PROD }}
          EOF

      - name: Deploy to Cloudflare Workers using Makefile
        run: make deploy-prd-wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  deploy-extension:
    needs: [build-project, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-build
          path: .

      - name: Install zip
        run: sudo apt-get install zip

      - name: Zip extension
        run: zip -r extension.zip frontend/ images/ manifest.json -x ".git/*" ".github/*" "*.bak" "node_modules/*" "backend/*"

      - name: Upload to Chrome Web Store
        uses: mobilefirstllc/cws-publish@latest
        with:
          action: "upload" # 'publish' for auto-publish
          client_id: ${{ secrets.CLIENT_ID_PROD }}
          client_secret: ${{ secrets.CLIENT_SECRET_PROD }}
          refresh_token: ${{ secrets.REFRESH_TOKEN }}
          extension_id: ${{ secrets.EXTENSION_ID }}
          zip_file: "extension.zip"

#   deploy-extension:
#     needs: [build-project, deploy-backend]
#     runs-on: ubuntu-latest
#
#     steps:
#     - name: Checkout
#       uses: actions/checkout@v4
#
#     - name: Setup Node.js
#       uses: actions/setup-node@v4
#       with:
#         node-version: '18'
#         cache: 'npm'
#
#     - name: Download build artifacts
#       uses: actions/download-artifact@v4
#       with:
#         name: extension-build
#
#     - name: Install zip
#       run: sudo apt-get install zip
#
#     - name: Zip extension
#       run: zip -r extension.zip frontend/ images/ manifest.json -x ".git/*" ".github/*" "*.bak" "node_modules/*" "backend/*"
#
#     - name: Upload & release
#       uses: mnao305/chrome-extension-upload@v5.0.0
#       with:
#         file-path: extension.zip
#         extension-id: ${{secrets.EXTENSION_ID}}
#         client-id: ${{secrets.CLIENT_ID}}
#         client-secret: ${{secrets.CLIENT_SECRET}}
#         refresh-token: ${{secrets.REFRESH_TOKEN}}
#         publish: false
